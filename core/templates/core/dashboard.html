<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .table-header {
      @apply text-xs font-semibold uppercase tracking-wider bg-gray-800/70 text-gray-200;
    }
    .card {
      @apply bg-gray-800 rounded-xl shadow-lg border border-gray-700 overflow-hidden;
    }
    .card-header {
      @apply px-4 py-3 text-sm font-bold bg-gray-900 border-b border-gray-700;
    }
    .control-btn {
      @apply px-5 py-2 rounded-lg border text-sm font-semibold 
             transition hover:-translate-y-0.5 hover:shadow;
    }
    .move-btn svg { @apply w-4 h-4; }
  </style>

  <script>
    async function moveEmployee(e, employeeId, direction, zone) {
      e.preventDefault();
      e.stopPropagation();
      
      let endpoint;
      if (zone === 'gyomu') {
        endpoint = direction === 'up'
          ? `/employee/${employeeId}/up-gyomu/`
          : `/employee/${employeeId}/down-gyomu/`;
      } else {
        endpoint = direction === 'up'
          ? `/employee/${employeeId}/up/`
          : `/employee/${employeeId}/down/`;
      }

      try {
        const res = await fetch(endpoint, { method: 'GET', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        if (res.ok) setTimeout(() => location.reload(), 300);
      } catch (err) { console.error(err); }
    }
  </script>
</head>

<body class="bg-gray-900 text-gray-100">

<div class="p-6 min-h-screen space-y-6">

  <!-- =======================
       TWO MAIN SPEECH ZONES
  ======================== -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

    <!-- =====================================
         LEFT ZONE: 業務スピーチ
    ====================================== -->
    <div class="card">
      <div class="card-header bg-amber-800 text-white">業務スピーチ</div>

      <!-- Header row -->
      <div class="grid table-header px-2 py-2 border-b border-gray-700"
           style="grid-template-columns: 40px 40px 40px 60px 1fr 90px 130px 90px;">
        <div></div>
        <div></div>
        <div class="text-center">状態</div>
        <div class="text-center">順番</div>
        <div>氏名</div>
        <div class="text-center">経過日数</div>
        <div class="text-center">登録日</div>
        <div class="text-center">今月</div>
      </div>

      <div class="max-h-[500px] overflow-y-auto text-sm">
        {% for member in bottom_zone %}
        <div class="grid items-center px-2 py-2 border-b border-gray-700 hover:bg-gray-700/40 transition"
             style="grid-template-columns: 40px 40px 40px 60px 1fr 90px 130px 90px">
          
          <!-- Up -->
          <div class="flex justify-center">
            {% if not forloop.first %}
            <button onclick="moveEmployee(event, {{ member.id }}, 'up', 'gyomu')" class="move-btn hover:text-yellow-300">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M14.7 12.7a1 1 0 01-1.4 0L10 9.4l-3.3 3.3a1 1 0 01-1.4-1.4l4-4a1 1 0 011.4 0l4 4a1 1 0 010 1.4z"/></svg>
            </button>
            {% else %}
            <div class="opacity-20"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M14.7 12.7a1 1 0 01-1.4 0L10 9.4l-3.3 3.3a1 1 0 01-1.4-1.4l4-4a1 1 0 011.4 0l4 4a1 1 0 010 1.4z"/></svg></div>
            {% endif %}
          </div>

          <!-- Down -->
          <div class="flex justify-center">
            {% if not forloop.last %}
            <button onclick="moveEmployee(event, {{ member.id }}, 'down', 'gyomu')" class="move-btn hover:text-yellow-300">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M5.3 7.3a1 1 0 011.4 0L10 10.6l3.3-3.3a1 1 0 111.4 1.4l-4 4a1 1 0 01-1.4 0l-4-4a1 1 0 010-1.4z"/></svg>
            </button>
            {% else %}
            <div class="opacity-20"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M14.7 12.7a1 1 0 01-1.4 0L10 9.4l-3.3 3.3a1 1 0 01-1.4-1.4l4-4a1 1 0 011.4 0l4 4a1 1 0 010 1.4z"/></svg></div>
            {% endif %}
          </div>

          <!-- Active checkbox -->
          <div class="flex justify-center">
            <form method="post" action="{% url 'employee-toggle-active' member.id %}">
              {% csrf_token %}
              <input type="checkbox" class="w-4 h-4" name="is_active"
                {% if member.is_rotation_active %}checked{% endif %}
                onchange="this.form.submit()">
            </form>
          </div>

          <div class="text-center">{{ member.order_gyomu }}</div>
          <div>{{ member.name }}</div>
          <div class="text-center">{{ member.days_passed|default:"-" }}</div>
          <div class="text-center text-xs">{{ member.speech_date|date:"Y-m-d"|default:"-" }}</div>
          <div class="text-center">{{ member.calendar }}</div>
        </div>
        {% endfor %}
      </div>
    </div>


    <!-- =====================================
         RIGHT ZONE: ３分間スピーチ
    ====================================== -->
    <div class="card">
      <div class="card-header bg-emerald-800 text-white">３分間スピーチ</div>

      <div class="grid table-header px-2 py-2 border-b border-gray-700"
           style="grid-template-columns: 40px 40px 40px 60px 1fr 90px 130px 90px;">
        <div></div>
        <div></div>
        <div class="text-center">状態</div>
        <div class="text-center">順番</div>
        <div>氏名</div>
        <div class="text-center">経過日数</div>
        <div class="text-center">登録日</div>
        <div class="text-center">今月</div>
      </div>

      <div class="max-h-[500px] overflow-y-auto text-sm">
        {% for member in top_zone %}
        <div class="grid items-center px-2 py-2 border-b border-gray-700 hover:bg-gray-700/40 transition"
             style="grid-template-columns: 40px 40px 40px 60px 1fr 90px 130px 90px">

          <!-- Up -->
          <div class="flex justify-center">
            {% if not forloop.first %}
            <button onclick="moveEmployee(event, {{ member.id }}, 'up', '3min')" class="move-btn hover:text-yellow-300">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M14.7 12.7a1 1 0 01-1.4 0L10 9.4l-3.3 3.3a1 1 0 01-1.4-1.4l4-4a1 1 0 011.4 0l4 4a1 1 0 010 1.4z"/></svg>
            </button>
            {% else %}
            <div class="opacity-20"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M14.7 12.7a1 1 0 01-1.4 0L10 9.4l-3.3 3.3a1 1 0 01-1.4-1.4l4-4a1 1 0 011.4 0l4 4a1 1 0 010 1.4z"/></svg></div>
            {% endif %}
          </div>

          <!-- Down -->
          <div class="flex justify-center">
            {% if not forloop.last %}
            <button onclick="moveEmployee(event, {{ member.id }}, 'down', '3min')" class="move-btn hover:text-yellow-300">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M5.3 7.3a1 1 0 011.4 0L10 10.6l3.3-3.3a1 1 0 111.4 1.4l-4 4a1 1 0 01-1.4 0l-4-4a1 1 0 010-1.4z"/></svg>
            </button>
            {% else %}
            <div class="opacity-20"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M14.7 12.7a1 1 0 01-1.4 0L10 9.4l-3.3 3.3a1 1 0 01-1.4-1.4l4-4a1 1 0 011.4 0l4 4a1 1 0 010 1.4z"/></svg></div>
            {% endif %}
          </div>

          <!-- Active checkbox -->
          <div class="flex justify-center">
            <form method="post" action="{% url 'employee-toggle-active' member.id %}">
              {% csrf_token %}
              <input type="checkbox" class="w-4 h-4"
                {% if member.is_rotation_active %}checked{% endif %}
                onchange="this.form.submit()">
            </form>
          </div>

          <div class="text-center">{{ member.order }}</div>
          <div>{{ member.name }}</div>
          <div class="text-center">{{ member.days_passed|default:"-" }}</div>
          <div class="text-center text-xs">{{ member.speech_date|date:"Y-m-d"|default:"-" }}</div>
          <div class="text-center">{{ member.calendar }}</div>

        </div>
        {% endfor %}
      </div>
    </div>

  </div>



  <!-- =====================================
       CONTROL BAR
  ====================================== -->
  <div class="card p-6">
    <div class="flex flex-wrap gap-4 justify-center">

      <a href="{% url 'add_member' %}"
         class="control-btn border-gray-400 text-gray-200 hover:bg-gray-200 hover:text-black">メンバーを追加</a>

      <a id="remove-member-btn" href="{% url 'remove_member_modal' %}" class="control-btn border-gray-400 text-gray-200 hover:bg-gray-200 hover:text-black">メンバーを削除</a>

      {% now "Y" as cur_year %}
      {% now "n" as cur_month %}

      <form method="post" action="{% url 'generate_schedule' %}">
        {% csrf_token %}
        <input type="hidden" name="year" value="{{ cur_year }}">
        <input type="hidden" name="month" value="{{ cur_month }}">
        <button type="submit" class="control-btn border-blue-400 text-blue-300 hover:bg-blue-500 hover:text-white">
          スケジュール生成
        </button>
      </form>

      <a href="{% url 'schedule_preview' cur_year cur_month %}"
         class="control-btn border-purple-400 text-purple-300 hover:bg-purple-500 hover:text-white">
        確認画面へ
      </a>

      {% if google_authenticated %}
      <form method="post" action="{% url 'send_to_calendar_month' cur_year cur_month %}">
        {% csrf_token %}
        <button type="submit" class="control-btn border-green-400 text-green-300 hover:bg-green-500 hover:text-white">
          送信
        </button>
      </form>
      {% else %}
      <a href="{% url 'google_auth' %}"
         class="control-btn border-orange-400 text-orange-300 hover:bg-orange-500 hover:text-white">
        ✕ Google認証
      </a>
      {% endif %}

      <form method="post" action="{% url 'retract_schedule' cur_year cur_month %}">
        {% csrf_token %}
        <button type="submit"
          class="control-btn border-red-400 text-red-300 hover:bg-red-500 hover:text-white"
          onclick="return confirm('今月の登録日付を削除してよろしいですか？');">
          登録日付の削除
        </button>
      </form>

    </div>
  </div>

</div>

  <!-- Modal root for AJAX-inserted modals -->
  <div id="modal-root"></div>

  <script>
  // Helper to get CSRF token from cookies
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  document.addEventListener('click', async function (e) {
    // Open modal when clicking remove-member button
    const target = e.target.closest('#remove-member-btn');
    if (!target) return;
    e.preventDefault();

    try {
      const res = await fetch(target.href, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
      if (!res.ok) {
        // fallback: navigate to href
        window.location.href = target.href;
        return;
      }
      const html = await res.text();
      const container = document.getElementById('modal-root');
      container.innerHTML = html;

      // show modal (already visible by fragment markup). Setup handlers
      const form = container.querySelector('#remove-member-form');
      const cancelBtn = container.querySelector('#remove-member-cancel');
      const errorP = container.querySelector('#remove-member-error');
      const submitBtn = container.querySelector('#remove-member-submit');

      if (cancelBtn) cancelBtn.addEventListener('click', () => { container.innerHTML = ''; });

      if (form) {
        form.addEventListener('submit', async function (ev) {
          ev.preventDefault();
          if (submitBtn) { submitBtn.disabled = true; }
          if (errorP) { errorP.classList.add('hidden'); errorP.textContent = ''; }

          const formData = new FormData(form);
          try {
            const resp = await fetch(form.action, {
              method: 'POST',
              headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
              },
              body: formData
            });

            const data = await resp.json();
            if (resp.ok && data.status === 'success') {
              // show quick toast then reload
              container.innerHTML = '';
              // small toast
              const t = document.createElement('div');
              t.className = 'fixed bottom-6 right-6 bg-green-600 text-white px-4 py-2 rounded';
              t.textContent = data.message || 'メンバーを削除しました。';
              document.body.appendChild(t);
              setTimeout(() => { t.remove(); location.reload(); }, 900);
              return;
            }

            // error
            const msg = data && data.message ? data.message : 'メンバー削除中にエラーが発生しました。';
            if (errorP) { errorP.textContent = msg; errorP.classList.remove('hidden'); }
          } catch (err) {
            if (errorP) { errorP.textContent = 'メンバー削除中にエラーが発生しました。'; errorP.classList.remove('hidden'); }
          } finally {
            if (submitBtn) submitBtn.disabled = false;
          }
        });
      }

    } catch (err) {
      // fallback navigation
      window.location.href = target.href;
    }
  });
  </script>

</body>
</html>
